# 服务器管理

## 1、服务器初始化上线
有赞的服务器初始化，主要分为kvm虚拟机初始化、云主机初始化。
### 1、kvm初始化

有关kvm的基础：https://www.cnblogs.com/wete/p/11099339.html  
kvm虚拟化技术实现原理：https://www.jianshu.com/p/40b44441aeb5

有赞kvm虚拟化交付：  

- 物理机安装（使用redhat系统的cobber系统来克隆系统）：https://doc.qima-inc.com/pages/viewpage.action?pageId=4849993  

克隆模板server列表

|环境|clone-server|
| :----: | :----: |
|生产|opsbd-prod-yz-clone0|
|测试|qabb-20gw1|
|黄龙办公室|ohl-kvm0-mon0|



- kvm初始化 https://doc.qima-inc.com/pages/viewpage.action?pageId=10034430

附带：  
服务器机型信息：https://doc.qima-inc.com/pages/viewpage.action?pageId=14339013

>一、硬盘接口的分类
硬盘接口通常分为五种类型：SATA接口硬盘、IDE接口硬盘、SCSI接口硬盘、光纤通道硬盘、SAS接口硬盘。

>IDE接口硬盘多用于家用产品中，也部分应用于服务器，SCSI接口的硬盘则主要应用于服务器市场，而光纤通道只在高端服务器上，价格昂贵。SATA是目前比较流行的的硬盘接口类型，目前市场上最普及的接口类型。
二、硬盘的分类

>硬盘分为固态硬盘（SSD 盘）、机械硬盘（HDD）、混合硬盘（HHD）三种。SSD采用闪存颗粒来存储，HDD采用磁性碟片来存储，混合硬盘(HHD: Hybrid Hard Disk)是把磁性硬盘和闪存集成到一起的一种硬盘。绝大多数硬盘都是固定硬盘，被永久性地密封固定在硬盘驱动器中。

raid策略： https://www.hack520.com/169.html

### 2、云主机初始化

![](https://tva1.sinaimg.cn/large/006tNbRwly1g9id79a8acj30va0ia0ud.jpg)

/etc/rc.local  
- 执行/opt/isys/init/init_runner.sh
主要的内容：（可以查看服务器/opt/isys/init/init_runner.sh脚本）

1. 检查锁文件是否存在，存在表明该脚本运行过，不需要再次执行，exit 0表示程序运行正确，脚本退出（ LOCK=/var/lib/os_env_init.lock  
[ -f "${LOCK}" ] && { echo "os_env_ini skip."; exit 0 ; } ）

2. <font color="#dd0000">初始化脚本执行log文件 /var/lib/os_env_init.log，失败可检查原因。</font> set -x 表示脚本运行脚本程序之前，先输出执行的那一行命令。-v 输入行被读取时,显示shell输入行（ set -x -v  
exec 1>/var/lib/os_env_init.log 2>&1）

3. 安装安装subversion版本控制软件（yum -y install subversion）
4. 更新svn数据，（svn up /opt/isys --username ireadonly --password ireadonly001 --no-auth-cache --trust-server-cert --non-interactive）  
    + -no-auth-cache: 不缓存用户token，(若添加此参数，则在workcopy目录下执行svn命令每次都需要添加用户名密码)
    + --trust-server-cert：信任任何ssl连接
    + --non-interactive: 无交互，多用于脚本自动化中。
5. 运行详细配置初始化脚本sh /opt/isys/init/os_env_init.sh

    1. 检查锁文件是否存在，存在则程序运行过，不需要再次执行
    2. 重新设置账号（如果系统中还有账号的uid>499,则调用userdel -r命令删除账号）
    3. 更新网关，重启网络
    4. 重启nscd确保运行（nscd可以开启linux系统DNS缓存）
    5. 清理不可信的第三方源（遍历/etc/yum.repos.d目录，删除非CentOS和非epel的yum源，清理yum缓存等）
    6. 安装root公钥
    7. 修复ucloud grub链接不正确问题
    8. 调整内核参数
    9. 更新系统
    10. 禁用服务（iptables、kdump、rpcbind、iscsi nfslock等服务，禁用swap分区、禁用grub图片等功能，详细服务列表请查看脚本）
    11. 清理垃圾文件，修改特定目录权限（清理/usr/bin/uga）
    12. 初始化salt服务(下载salt-minion服务)
    13. salt-call同步配置（minion执行salt-call state.highstate操作的时候，minion会主动到master上面把/srv/salt/top.sls里面定义的东西下载到本地，然后执行）

## 2、服务器改名

参考文档： https://doc.qima-inc.com/display/CloudTech/cloudcli

cloudcli是有赞内部使用的云主机管理工具，它对公有云（ucloud、qcloud等）的API接口进行了统一的封装，关联整合了CMDB等内部系统。

```bash
$ cloudcli rename -h
usage: cloudcli rename [-h] HOSTNAME NEW_HOSTNAME

positional arguments:
  HOSTNAME
  NEW_HOSTNAME

optional arguments:
  -h, --help    show this help message and exit
```

机器改名时，程序的行为：

- 修改公有云上VM实例的名称
- 修改CMDB的信息
- 修改机器OS相关的信息

## 3、 服务器下线流程

### 1、物理机下线流程

参考文档：https://doc.qima-inc.com/pages/viewpage.action?pageId=48942425

1. check 是否还有业务监听（ps、netstat）
2. 停止系统服务，根据实际情况停止相关应用
3. 除salt的自动化配置
4. 关闭 开机自动启动服务
5. 清理数据 (PS：物理机上都有raid，会屏蔽底层ssd的属性，rotation不能作为判断标准，应使用raid工具看实际磁盘类型：https://www.cnblogs.com/276815076/p/3282422.html)
6. 关闭并且删除对应机器的有关监控程序

### 2、云主机下线流程

参考文档：https://doc.qima-inc.com/pages/viewpage.action?pageId=55660812

1. 统一接入中调整upstream，下掉目标机器
2. 在ops平台：http://ops.qima-inc.com/#/applications 回收机器。

## 4、服务器交付检查标准

详细标准查看文档： https://doc.qima-inc.com/pages/viewpage.action?pageId=55660816
